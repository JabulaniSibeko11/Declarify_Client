@model Declarify.Models.ViewModels.TaskDetailViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Complete Declaration of Interest";
    var templateConfig = !string.IsNullOrEmpty(Model.Template.TemplateConfig)
        ? JsonSerializer.Deserialize<TemplateConfig>(Model.Template.TemplateConfig, new JsonSerializerOptions { PropertyNameCaseInsensitive = true })
        : new TemplateConfig();
    var draftData = Model.DraftSubmission?.FormData != null
        ? JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(Model.DraftSubmission.FormData)
        : new Dictionary<string, JsonElement>();
    var token = Context.Request.Query["token"].ToString();
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="~/css/completeformcss1.css" rel="stylesheet" />
    <style>
        .table-field {
            width: 100%;
            margin-top: 12px;
        }

            .table-field table {
                width: 100%;
                border-collapse: collapse;
                background: white;
            }

            .table-field th {
                background: #f3f4f6;
                padding: 12px;
                text-align: left;
                font-weight: 600;
                border: 1px solid #e5e7eb;
            }

            .table-field td {
                padding: 8px;
                border: 1px solid #e5e7eb;
            }

            .table-field input {
                width: 100%;
                padding: 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
            }

        .table-add-row-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: #00C2CB;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .table-row-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .advanced-table-field {
            width: 100%;
            margin-top: 12px;
        }

        .advanced-table-grid {
            display: grid;
            gap: 16px;
            margin-top: 12px;
        }

        .advanced-table-row {
            display: grid;
            gap: 12px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .signature-field {
            margin-top: 12px;
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background: #f9fafb;
            text-align: center;
        }

        .signature-pad {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-top: 12px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .field-heading {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 24px 0 12px 0;
        }

        .field-paragraph {
            color: #4b5563;
            line-height: 1.6;
            margin: 12px 0;
        }

        .field-divider {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 24px 0;
        }
    </style>
</head>
<body>
    <div class="hero-header">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title"><span class="accent">@Model.Template.TemplateName</span></h1>
                <p style="opacity: 0.9; font-size: 1.1rem;">@(!string.IsNullOrEmpty(Model.Template.Description) ? Model.Template.Description : "Complete your declaration")</p>
                <div class="hero-meta">
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span>Due: @Model.Task.DueDate.ToString("MMMM dd, yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="progress-container">
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-text" id="progressText">0% Complete</div>
        </div>
    </div>
    <div class="container form-wrapper">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-error"><span>@TempData["Error"]</span></div>
        }
        @if (!Model.CanSubmit)
        {
            <div class="alert alert-warning"><span>This declaration has already been submitted.</span></div>
        }
        <div class="welcome-banner">
            <span class="welcome-text">Welcome back, <strong>@Model.EmployeeName</strong>!</span>
        </div>
        <form id="doiForm">
            <input type="hidden" id="taskToken" value="@token" />
            <input type="hidden" id="employeeSignatureData" value="@Model.EmployeeSignature" />
            <input type="hidden" id="employeeName" value="@Model.EmployeeName" />
            <input type="hidden" id="employeeEmail" value="@Model.EmployeeEmail" />
            <div class="form-card user-details-card">
                <div class="section-header"><span class="section-number user-icon">👤</span><span>Your Details</span></div>
                <div class="user-details-grid">
                    <div class="detail-item"><div class="detail-label">Full Name</div><div class="detail-value">@Model.EmployeeName</div></div>
                    <div class="detail-item"><div class="detail-label">Email</div><div class="detail-value">@Model.EmployeeEmail</div></div>
                    <div class="detail-item"><div class="detail-label">Employee ID</div><div class="detail-value">EMP-@Model.Task.EmployeeId.ToString("D5")</div></div>
                </div>
            </div>
            @if (templateConfig?.Sections != null && templateConfig.Sections.Any())
            {
                var orderedSections = templateConfig.Sections.OrderBy(s => s.SectionOrder).ToList();
                for (int i = 0; i < orderedSections.Count; i++)
                {
                    var sec = orderedSections[i];
                    var sectionIndex = i + 1;
                    <div class="form-card" data-section="@sectionIndex" data-section-id="@sec.SectionId">
                        <div class="section-header"><span class="section-number">@sectionIndex</span><span>@sec.SectionTitle</span></div>
                        @if (!string.IsNullOrEmpty(sec.Disclaimer))
                        {
                            <p class="section-description">@sec.Disclaimer</p>
                        }
                        @if (sec.Fields != null && sec.Fields.Any())
                        {
                            var orderedFields = sec.Fields.OrderBy(f => f.Order).ToList();
                            foreach (var field in orderedFields)
                            {
                                <div class="form-group" data-field-id="@field.FieldId">
                                    @switch (field.FieldType.ToLower())
                                    {
                                        case "heading":
                                            <h3 class="field-heading">@field.FieldLabel</h3>
                                            break;
                                        case "paragraph":
                                            <p class="field-paragraph">
                                                @(!string.IsNullOrWhiteSpace(field.HelpText)
                                                                        ? field.HelpText
                                                                        : field.FieldLabel)
                                            </p>
                                            break;


                                        case "divider":
                                            <hr class="field-divider" />
                                            break;
                                        case "text":
                                        case "email":
                                        case "number":
                                        case "phone":
                                        case "url":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            @if (!string.IsNullOrEmpty(field.HelpText))
                                            {
                                                <small style="display: block; margin-bottom: 8px; color: #6b7280;">@field.HelpText</small>
                                            }
                                            <input type="@field.FieldType" class="form-input" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") placeholder="@(field.Placeholder ?? $"Enter {field.FieldLabel.ToLower()}")" value="" />
                                            break;
                                        case "currency":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <div style="position: relative;">
                                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">R</span>
                                                <input type="number" class="form-input" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") placeholder="0.00" step="0.01" style="padding-left: 32px;" />
                                            </div>
                                            break;
                                        case "date":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <input type="date" class="form-input" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") />
                                            break;
                                        case "textarea":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <textarea class="form-textarea" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") placeholder="@(field.Placeholder ?? "")"></textarea>
                                            break;
                                        case "select":
                                        case "dropdown":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <select class="form-select" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "")>
                                                <option value="">Select...</option>
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    foreach (var option in field.Options)
                                                    {
                                                        <option value="@option">@option</option>
                                                    }
                                                }
                                            </select>
                                            break;
                                        case "checkbox":
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") value="true" />
                                                    <label for="@field.FieldId">@field.FieldLabel</label>
                                                </div>
                                            </div>
                                            break;
                                        case "boolean":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="radio-group">
                                                <div class="radio-item"><input type="radio" id="@($"{field.FieldId}-yes")" name="@field.FieldId" @(field.Required ? "required" : "") value="Yes" /><label for="@($"{field.FieldId}-yes")">Yes</label></div>
                                                <div class="radio-item"><input type="radio" id="@($"{field.FieldId}-no")" name="@field.FieldId" value="No" /><label for="@($"{field.FieldId}-no")">No</label></div>
                                            </div>
                                            break;
                                        case "radio":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="radio-group">
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    for (int optIdx = 0; optIdx < field.Options.Count; optIdx++)
                                                    {
                                                        var option = field.Options[optIdx];
                                                        var radioId = $"{field.FieldId}_option{optIdx}";
                                                        <div class="radio-item">
                                                            <input type="radio" id="@radioId" name="@field.FieldId" @(field.Required && optIdx == 0 ? "required" : "") value="@option" />
                                                            <label for="@radioId">@option</label>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            break;
                                        case "file":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <input type="file" class="form-input" id="@field.FieldId" name="@field.FieldId" @(field.Required ? "required" : "") accept="@(field.Validation?.FileTypes ?? ".pdf,.doc,.docx")" />
                                            <small>Max: @(field.Validation?.MaxSize ?? 5)MB</small>
                                            break;
                                        case "table":
                                            <label class="form-label @(field.Required ? "required" : "")">
                                                @field.FieldLabel
                                            </label>

                                            <div class="table-field" data-table-id="@field.FieldId">
                                                <table id="table-@field.FieldId">
                                                    <thead>
                                                        <tr>
                                                            @{
                                                                // Fallback columns when TableConfig is missing
                                                                var columns = field.TableConfig?.Columns?.Any() == true
                                                                ? field.TableConfig.Columns
                                                                : new List<string> { "Description", "Details", "Value" };

                                                                foreach (var column in columns)
                                                                {
                                                                    <th>@column</th>
                                                                }
                                                            }
                                                            <th style="width:80px;">Actions</th>
                                                        </tr>
                                                    </thead>

                                                    <tbody id="tbody-@field.FieldId">
                                                        @{
                                                            var minRows = field.TableConfig?.MinRows ?? 1;
                                                            for (int rowIdx = 0; rowIdx < minRows; rowIdx++)
                                                            {
                                                                <tr class="table-row">
                                                                    @for (int colIdx = 0; colIdx < columns.Count; colIdx++)
                                                                    {
                                                                        <td>
                                                                            <input type="text"
                                                                                   name="@($"{field.FieldId}_row{rowIdx}_col{colIdx}")"
                                                                                   @(field.Required && rowIdx == 0 ? "required" : "") />
                                                                        </td>
                                                                    }
                                                                    <td>
                                                                        <button type="button"
                                                                                class="table-row-delete"
                                                                                onclick="deleteTableRow(this)">
                                                                            Delete
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>

                                                <button type="button"
                                                        class="table-add-row-btn"
                                                        onclick="addTableRow(
                                            '@field.FieldId',
                                            @(field.TableConfig?.Columns?.Count ?? 3),
                                            @field.Required.ToString().ToLower()
                                        )">
                                                    + Add Row
                                                </button>
                                            </div>
                                            break;



                                        case "advancedtable":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="advanced-table-field">
                                                @{
                                                    var gridCols = field.GridColumns ?? 3;
                                                    var numRows = field.Rows ?? 4;
                                                }
                                                <div class="advanced-table-grid" style="grid-template-columns: repeat(@gridCols, 1fr);">
                                                    @for (int rowIdx = 0; rowIdx < numRows; rowIdx++)
                                                    {
                                                        <div class="advanced-table-row" style="grid-column: 1 / -1;">
                                                            <h4>Row @(rowIdx + 1)</h4>
                                                            <div style="display: grid; grid-template-columns: repeat(@gridCols, 1fr); gap: 12px;">
                                                                @if (field.Columns != null && field.Columns.Any())
                                                                {
                                                                    foreach (var column in field.Columns)
                                                                    {
                                                                        <div>
                                                                            <label style="display: block; margin-bottom: 4px; font-size: 13px;">@column.Name</label>
                                                                            @switch (column.Type?.ToLower())
                                                                            {
                                                                                case "number":
                                                                                    <input type="number" name="@($"{field.FieldId}_row{rowIdx}_{column.Name}")" @(field.Required && rowIdx == 0 ? "required" : "") />
                                                                                    break;
                                                                                case "date":
                                                                                    <input type="date" name="@($"{field.FieldId}_row{rowIdx}_{column.Name}")" @(field.Required && rowIdx == 0 ? "required" : "") />
                                                                                    break;
                                                                                case "email":
                                                                                    <input type="email" name="@($"{field.FieldId}_row{rowIdx}_{column.Name}")" @(field.Required && rowIdx == 0 ? "required" : "") />
                                                                                    break;
                                                                                default:
                                                                                    <input type="text" name="@($"{field.FieldId}_row{rowIdx}_{column.Name}")" @(field.Required && rowIdx == 0 ? "required" : "") />
                                                                                    break;
                                                                            }
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                            break;
                                        case "signature":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="signature-field">
                                                <p style="margin: 0 0 12px 0; color: #6b7280;">Your signature from profile</p>
                                                <div class="signature-pad"><img src="@Model.EmployeeSignature" alt="Signature" style="max-height: 100px;" /></div>
                                                <input type="hidden" name="@field.FieldId" value="@Model.EmployeeSignature" @(field.Required ? "required" : "") />
                                            </div>
                                            break;
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            }
            @if (Model.CanSubmit)
            {
                <div class="action-buttons">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">💾 Save as Draft</button>
                    <button type="button" class="btn-primary" onclick="showAttestationModal()">✓ Submit Declaration</button>
                </div>
            }
        </form>
    </div>
    <div class="modal-overlay" id="attestationModal">
        <div class="attestation-modal">
            <div class="modal-header">
                <div class="modal-header-content">
                    <h2 class="modal-title">Declaration & Attestation</h2>
                    <p class="modal-subtitle">Please review and confirm your submission</p>
                </div>
            </div>
            <div class="modal-body">
                <div class="attestation-text-container">
                    <p class="attestation-text">I hereby declare that the information provided is <strong>true, complete, and accurate</strong>.</p>
                </div>
                <div class="employee-info">
                    <div class="info-row"><span class="info-label">Employee Name:</span><span class="info-value" id="modalEmployeeName"></span></div>
                    <div class="info-row"><span class="info-label">Email:</span><span class="info-value" id="modalEmployeeEmail"></span></div>
                    <div class="info-row"><span class="info-label">Date:</span><span class="info-value" id="modalSubmissionDate"></span></div>
                </div>
                <div class="signature-display">
                    <div class="signature-label">Your Digital Signature</div>
                    <img id="modalSignatureImage" class="signature-image" alt="Signature" />
                </div>
                <div class="attestation-checkbox-modal">
                    <input type="checkbox" id="modalAttestationCheck" required />
                    <label for="modalAttestationCheck"><strong>I certify all information is truthful and complete.</strong></label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" onclick="closeAttestationModal()">Cancel</button>
                <button type="button" class="btn-modal-confirm" id="confirmSubmitBtn" onclick="confirmSubmission()" disabled>✓ Confirm & Submit</button>
            </div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    <div class="autosave-indicator" id="autosaveIndicator"><div class="autosave-dot"></div><span>Draft saved</span></div>
    <script>
        let autoSaveTimer = null;
        let tableRowCounters = {};
        const draftData = @Html.Raw(JsonSerializer.Serialize(draftData));

        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            loadDraftData();
            updateProgress();
            setupAutoSave();
            setupAttestationModal();
            initializeTableCounters();
        });

        function initializeForm() {
            const form = document.getElementById('doiForm');
            form.addEventListener('input', updateProgress);
            form.addEventListener('change', updateProgress);
        }

        function initializeTableCounters() {
            document.querySelectorAll('[data-table-id]').forEach(table => {
                const tableId = table.dataset.tableId;
                const tbody = document.getElementById(`tbody-${tableId}`);
                if (tbody) tableRowCounters[tableId] = tbody.querySelectorAll('tr').length;
            });
        }

        function setupAttestationModal() {
            const checkbox = document.getElementById('modalAttestationCheck');
            const confirmBtn = document.getElementById('confirmSubmitBtn');
            checkbox.addEventListener('change', function() {
                confirmBtn.disabled = !this.checked;
            });
        }

        function showAttestationModal() {
            const form = document.getElementById('doiForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            document.getElementById('modalEmployeeName').textContent = document.getElementById('employeeName').value;
            document.getElementById('modalEmployeeEmail').textContent = document.getElementById('employeeEmail').value;
            document.getElementById('modalSubmissionDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            document.getElementById('modalSignatureImage').src = document.getElementById('employeeSignatureData').value;
            document.getElementById('modalAttestationCheck').checked = false;
            document.getElementById('confirmSubmitBtn').disabled = true;
            document.getElementById('attestationModal').classList.add('active');
        }

        function closeAttestationModal() {
            document.getElementById('attestationModal').classList.remove('active');
        }

        async function confirmSubmission() {
            const token = document.getElementById('taskToken').value;
            const formData = collectFormData();
            const signatureData = document.getElementById('employeeSignatureData').value;
            document.getElementById('loadingOverlay').classList.add('active');
            closeAttestationModal();
            try {
                const response = await fetch('@Url.Action("Submit", "Employee")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Token: token, FormData: JSON.stringify(formData), AttestationSignature: signatureData })
                });
                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirectUrl;
                } else {
                    alert(result.message || 'Error submitting form.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting form.');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function loadDraftData() {
            if (!draftData || Object.keys(draftData).length === 0) return;
            Object.keys(draftData).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    const value = draftData[key];
                    if (field.type === 'checkbox') {
                        field.checked = value === true || value === 'true';
                    } else if (field.type === 'radio') {
                        if (field.value === value) field.checked = true;
                    } else {
                        try {
                            field.value = typeof value === 'object' && value.ValueKind !== undefined ? (value.GetString ? value.GetString() : '') : value;
                        } catch {
                            field.value = value.toString();
                        }
                    }
                }
            });
        }

        function setupAutoSave() {
            document.getElementById('doiForm').addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(saveDraft, 3000);
            });
        }

        async function saveDraft() {
            try {
                const response = await fetch('@Url.Action("SaveDraft", "Employee")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Token: document.getElementById('taskToken').value, FormData: JSON.stringify(collectFormData()) })
                });
                const result = await response.json();
                if (result.success) showAutosaveIndicator();
            } catch (error) {
                console.error('Error saving draft:', error);
            }
        }

        function showAutosaveIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 2000);
        }

        function collectFormData() {
            const formData = {};
            document.querySelectorAll('#doiForm input, #doiForm select, #doiForm textarea').forEach(field => {
                if (field.name && !['taskToken','employeeSignatureData','employeeName','employeeEmail','modalAttestationCheck'].includes(field.id)) {
                    if (field.type === 'checkbox') {
                        formData[field.name] = field.checked;
                    } else if (field.type === 'radio') {
                        if (field.checked) formData[field.name] = field.value;
                    } else if (field.type === 'file') {
                        if (field.files && field.files.length > 0) formData[field.name] = field.files[0].name;
                    } else {
                        formData[field.name] = field.value;
                    }
                }
            });
            return formData;
        }

        function updateProgress() {
            const form = document.getElementById('doiForm');
            const requiredFields = form.querySelectorAll('[required]');
            let completed = 0;
            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    if (field.checked) completed++;
                } else if (field.type === 'radio') {
                    const radioGroup = form.querySelectorAll(`[name="${field.name}"]`);
                    if (Array.from(radioGroup).some(r => r.checked)) completed++;
                } else if (field.value && field.value.trim() !== '') {
                    completed++;
                }
            });
            const percentage = requiredFields.length > 0 ? Math.round((completed / requiredFields.length) * 100) : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '% Complete';
        }

        function addTableRow(tableId, numColumns, isRequired) {
            const tbody = document.getElementById(`tbody-${tableId}`);
            if (!tbody) return;
            if (!tableRowCounters[tableId]) tableRowCounters[tableId] = tbody.querySelectorAll('tr').length;
            const rowIndex = tableRowCounters[tableId]++;
            const newRow = document.createElement('tr');
            newRow.className = 'table-row';
            let rowHtml = '';
            for (let i = 0; i < numColumns; i++) {
                rowHtml += `<td><input type="text" name="${tableId}_row${rowIndex}_col${i}" ${isRequired && rowIndex === 0 ? 'required' : ''} /></td>`;
            }
            rowHtml += '<td><button type="button" class="table-row-delete" onclick="deleteTableRow(this)">Delete</button></td>';
            newRow.innerHTML = rowHtml;
            tbody.appendChild(newRow);
        }

        function deleteTableRow(button) {
            const row = button.closest('tr');
            if (row && confirm('Delete this row?')) row.remove();
        }

        document.getElementById('attestationModal').addEventListener('click', function(e) {
            if (e.target === this) closeAttestationModal();
        });
    </script>
</body>
</html>

@functions {
    public class TemplateConfig
    {
        public List<SectionConfig> Sections { get; set; } = new();
    }

    public class SectionConfig
    {
        public string SectionId { get; set; } = string.Empty;
        public string SectionTitle { get; set; } = string.Empty;
        public string? Disclaimer { get; set; }
        public int SectionOrder { get; set; }
        public List<FieldConfig> Fields { get; set; } = new();
    }

    public class FieldConfig
    {
        public string FieldId { get; set; } 
        public string? FieldLabel { get; set; } 
        public string? FieldType { get; set; } 
        public bool Required { get; set; }
        public int Order { get; set; }

        public string? ConditionalOn { get; set; }
        public List<string>? Options { get; set; }
        public string? Placeholder { get; set; }
        public string? HelpText { get; set; }
        public TableConfig? TableConfig { get; set; }
        public List<ColumnConfig>? Columns { get; set; }
        public int? Rows { get; set; }
        public int? GridColumns { get; set; }
        public ValidationConfig? Validation { get; set; }
    }

    public class TableConfig
    {
        public List<string> Columns { get; set; } = new();
        public int MinRows { get; set; }
        public bool AllowAddRows { get; set; }
    }

    public class ColumnConfig
    {
        public string? Name { get; set; } 
        public string Type { get; set; } 
    }

    public class ValidationConfig
    {
        public string? Min { get; set; }
        public string? Max { get; set; }
        public string? FileTypes { get; set; }
        public int? MaxSize { get; set; }
        public bool? AllowTyped { get; set; }
    }
}
