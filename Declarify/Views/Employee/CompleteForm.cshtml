@model Declarify.Models.ViewModels.TaskDetailViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Complete Declaration of Interest";

    // Parse template configuration with correct property mapping
    var templateConfig = !string.IsNullOrEmpty(Model.Template.TemplateConfig)
        ? JsonSerializer.Deserialize<TemplateConfig>(Model.Template.TemplateConfig, new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        })
        : new TemplateConfig();

    // Parse draft data if exists
    var draftData = Model.DraftSubmission?.FormData != null
        ? JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(Model.DraftSubmission.FormData)
        : new Dictionary<string, JsonElement>();

    // Get token from query string
    var token = Context.Request.Query["token"].ToString();
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="~/css/completeformcss1.css" rel="stylesheet" />
</head>
<body>
    <!-- Hero Header -->
    <div class="hero-header">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="accent">@Model.Template.TemplateName</span>
                </h1>
                <p style="opacity: 0.9; font-size: 1.1rem;">
                    @(!string.IsNullOrEmpty(Model.Template.Description) ? Model.Template.Description : "Complete your declaration with clarity and confidence")
                </p>

                <div class="hero-meta">
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>Due: @Model.Task.DueDate.ToString("MMMM dd, yyyy")</span>
                    </div>
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="status-badge status-@Model.Task.Status.ToLower()">@Model.Task.Status</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="container">
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% Complete</div>
        </div>
    </div>

    <!-- Form Content -->
    <div class="container form-wrapper">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-error">
                <svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>@TempData["Error"]</span>
            </div>
        }

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">
                <svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>@TempData["Success"]</span>
            </div>
        }

        @if (!Model.CanSubmit)
        {
            <div class="alert alert-warning">
                <svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span>This declaration has already been submitted and cannot be edited.</span>
            </div>
        }

        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <svg class="welcome-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="welcome-text">Welcome back, <strong>@Model.EmployeeName</strong>!</span>
        </div>

        <form id="doiForm">
            <input type="hidden" id="taskToken" value="@token" />
            <input type="hidden" id="employeeSignatureData" value="@Model.EmployeeSignature" />
            <input type="hidden" id="employeeName" value="@Model.EmployeeName" />
            <input type="hidden" id="employeeEmail" value="@Model.EmployeeEmail" />

            <!-- User Details Section (Pre-populated) -->
            <div class="form-card user-details-card">
                <div class="section-header">
                    <span class="section-number user-icon">
                        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    <span>Your Details</span>
                </div>
                <p class="section-description">This information has been pre-filled from your employee profile.</p>

                <div class="user-details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Full Name</div>
                        <div class="detail-value">@Model.EmployeeName</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email Address</div>
                        <div class="detail-value">@Model.EmployeeEmail</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Employee ID</div>
                        <div class="detail-value">EMP-@Model.Task.EmployeeId.ToString("D5")</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Declaration Type</div>
                        <div class="detail-value">@Model.Template.TemplateName</div>
                    </div>
                </div>
            </div>

            @if (templateConfig?.Sections != null && templateConfig.Sections.Any())
            {
                var orderedSections = templateConfig.Sections.OrderBy(s => s.SectionOrder).ToList();

                for (int i = 0; i < orderedSections.Count; i++)
                {
                    var sec = orderedSections[i];
                    var sectionIndex = i + 1;

                    <div class="form-card" data-section="@sectionIndex" data-section-id="@sec.SectionId">
                        <div class="section-header">
                            <span class="section-number">@sectionIndex</span>
                            <span>@sec.SectionTitle</span>
                        </div>

                        @if (!string.IsNullOrEmpty(sec.Disclaimer))
                        {
                            <p class="section-description">@sec.Disclaimer</p>
                        }

                        @if (sec.Fields != null && sec.Fields.Any())
                        {
                            var orderedFields = sec.Fields.OrderBy(f => f.Order).ToList();

                            foreach (var field in orderedFields)
                            {
                                <div class="form-group" data-field-id="@field.FieldId">
                                    @switch (field.FieldType.ToLower())
                                    {
                                        case "text":
                                        case "email":
                                        case "number":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">
                                                @field.FieldLabel
                                            </label>
                                            <input type="@field.FieldType"
                                                   class="form-input"
                                                   id="@field.FieldId"
                                                   name="@field.FieldId"
                                                   @(field.Required ? "required" : "")
                                                   placeholder="Enter @field.FieldLabel.ToLower()"
                                                   value="" />
                                            break;

                                        case "date":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">
                                                @field.FieldLabel
                                            </label>
                                            <input type="date"
                                                   class="form-input"
                                                   id="@field.FieldId"
                                                   name="@field.FieldId"
                                                   @(field.Required ? "required" : "")
                                                   value="" />
                                            break;

                                        case "textarea":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">
                                                @field.FieldLabel
                                            </label>
                                            <textarea class="form-textarea"
                              id="@field.FieldId"
                              name="@field.FieldId"
                              @(field.Required ? "required" : "")
                              placeholder="Enter @field.FieldLabel.ToLower()"></textarea>
                                            break;

                                        case "select":
                                        case "dropdown":
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">
                                                @field.FieldLabel
                                            </label>
                                            <select class="form-select"
                                                    id="@field.FieldId"
                                                    name="@field.FieldId"
                                                    @(field.Required ? "required" : "")>
                                                <option value="">Select @field.FieldLabel.ToLower()...</option>
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    foreach (var option in field.Options)
                                                    {
                                                        <option value="@option">@option</option>
                                                    }
                                                }
                                            </select>
                                            break;

                                        case "checkbox":
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="checkbox"
                                                           id="@field.FieldId"
                                                           name="@field.FieldId"
                                                           @(field.Required ? "required" : "")
                                                           value="true" />
                                                    <label for="@field.FieldId">@field.FieldLabel</label>
                                                </div>
                                            </div>
                                            break;

                                        case "radio":
                                            <label class="form-label @(field.Required ? "required" : "")">
                                                @field.FieldLabel
                                            </label>
                                            <div class="radio-group">
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    for (int optIdx = 0; optIdx < field.Options.Count; optIdx++)
                                                    {
                                                        var option = field.Options[optIdx];
                                                        var radioId = $"{field.FieldId}_option{optIdx}";
                                                        <div class="radio-item">
                                                            <input type="radio"
                                                                   id="@radioId"
                                                                   name="@field.FieldId"
                                                                   @(field.Required && optIdx == 0 ? "required" : "")
                                                                   value="@option" />
                                                            <label for="@radioId">@option</label>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            break;
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            }

            <!-- Action Buttons -->
            @if (Model.CanSubmit)
            {
                <div class="action-buttons">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">
                        💾 Save as Draft
                    </button>
                    <button type="button" class="btn-primary" id="submitBtn" onclick="showAttestationModal()">
                        ✓ Submit Declaration
                    </button>
                </div>
            }
        </form>
    </div>

    <!-- Attestation Modal -->
    <div class="modal-overlay" id="attestationModal">
        <div class="attestation-modal">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="modal-title">Declaration & Attestation</h2>
                    <p class="modal-subtitle">Please review and confirm your submission</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="attestation-text-container">
                    <p class="attestation-text">
                        I hereby declare that the information provided in this Declaration of Interest is <strong>true, complete, and accurate</strong> to the best of my knowledge. I understand that any false or misleading information may result in disciplinary action in accordance with applicable legislation and organizational policies.
                    </p>
                </div>

                <div class="employee-info">
                    <div class="info-row">
                        <span class="info-label">Employee Name:</span>
                        <span class="info-value" id="modalEmployeeName"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email Address:</span>
                        <span class="info-value" id="modalEmployeeEmail"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Submission Date:</span>
                        <span class="info-value" id="modalSubmissionDate"></span>
                    </div>
                </div>

                <div class="signature-display">
                    <div class="signature-label">Your Digital Signature</div>
                    <img id="modalSignatureImage" class="signature-image" alt="Your Signature" />
                </div>

                <div class="attestation-checkbox-modal">
                    <input type="checkbox" id="modalAttestationCheck" required />
                    <label for="modalAttestationCheck">
                        <strong>I certify that all information provided is truthful and complete.</strong> I understand my obligations under the relevant legislation and organizational policies, and I acknowledge that this digital signature has the same legal effect as a handwritten signature.
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" onclick="closeAttestationModal()">
                    Cancel
                </button>
                <button type="button" class="btn-modal-confirm" id="confirmSubmitBtn" onclick="confirmSubmission()" disabled>
                    ✓ Confirm & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="autosave-indicator" id="autosaveIndicator">
        <div class="autosave-dot"></div>
        <span>Draft saved</span>
    </div>

    <script>
        // Global variables
        let autoSaveTimer = null;
        const draftData = @Html.Raw(JsonSerializer.Serialize(draftData));

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            loadDraftData();
            updateProgress();
            setupAutoSave();
            setupAttestationModal();
        });

        function initializeForm() {
            const form = document.getElementById('doiForm');
            form.addEventListener('input', updateProgress);
            form.addEventListener('change', updateProgress);
        }

        function setupAttestationModal() {
            const checkbox = document.getElementById('modalAttestationCheck');
            const confirmBtn = document.getElementById('confirmSubmitBtn');

            checkbox.addEventListener('change', function() {
                confirmBtn.disabled = !this.checked;
            });
        }

        function showAttestationModal() {
            // Validate form first
            const form = document.getElementById('doiForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get employee data
            const employeeName = document.getElementById('employeeName').value;
            const employeeEmail = document.getElementById('employeeEmail').value;
            const signatureData = document.getElementById('employeeSignatureData').value;

            // Populate modal
            document.getElementById('modalEmployeeName').textContent = employeeName;
            document.getElementById('modalEmployeeEmail').textContent = employeeEmail;
            document.getElementById('modalSubmissionDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('modalSignatureImage').src = signatureData;

            // Reset checkbox
            document.getElementById('modalAttestationCheck').checked = false;
            document.getElementById('confirmSubmitBtn').disabled = true;

            // Show modal
            document.getElementById('attestationModal').classList.add('active');
        }

        function closeAttestationModal() {
            document.getElementById('attestationModal').classList.remove('active');
        }

        async function confirmSubmission() {
            const token = document.getElementById('taskToken').value;
            const formData = collectFormData();
            const signatureData = document.getElementById('employeeSignatureData').value;

            document.getElementById('loadingOverlay').classList.add('active');
            closeAttestationModal();

            try {
                const response = await fetch('@Url.Action("Submit", "Employee")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Token: token,
                        FormData: JSON.stringify(formData),
                        AttestationSignature: signatureData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirectUrl;
                } else {
                    alert(result.message || 'Error submitting form. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Error submitting form. Please try again.');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function loadDraftData() {
            if (!draftData || Object.keys(draftData).length === 0) return;

            Object.keys(draftData).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    const value = draftData[key];

                    if (field.type === 'checkbox') {
                        field.checked = value === true || value === 'true';
                    } else if (field.type === 'radio') {
                        if (field.value === value) {
                            field.checked = true;
                        }
                    } else {
                        try {
                            if (typeof value === 'object' && value.ValueKind !== undefined) {
                                field.value = value.GetString ? value.GetString() : '';
                            } else {
                                field.value = value;
                            }
                        } catch {
                            field.value = value.toString();
                        }
                    }
                }
            });
        }

        function setupAutoSave() {
            const form = document.getElementById('doiForm');

            form.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(saveDraft, 3000);
            });
        }

        async function saveDraft() {
            const token = document.getElementById('taskToken').value;
            const formData = collectFormData();

            try {
                const response = await fetch('@Url.Action("SaveDraft", "Employee")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Token: token,
                        FormData: JSON.stringify(formData)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAutosaveIndicator();
                } else {
                    console.error('Draft save failed:', result.message);
                }
            } catch (error) {
                console.error('Error saving draft:', error);
            }
        }

        function showAutosaveIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            indicator.classList.add('active');

            setTimeout(() => {
                indicator.classList.remove('active');
            }, 2000);
        }

        function collectFormData() {
            const formData = {};
            const form = document.getElementById('doiForm');

            const fields = form.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                if (field.name && field.id !== 'taskToken' && field.id !== 'employeeSignatureData' && field.id !== 'employeeName' && field.id !== 'employeeEmail' && field.id !== 'modalAttestationCheck') {
                    if (field.type === 'checkbox') {
                        formData[field.name] = field.checked;
                    } else if (field.type === 'radio') {
                        if (field.checked) {
                            formData[field.name] = field.value;
                        }
                    } else {
                        formData[field.name] = field.value;
                    }
                }
            });

            return formData;
        }

        function updateProgress() {
            const form = document.getElementById('doiForm');
            const requiredFields = form.querySelectorAll('[required]');
            let completed = 0;

            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    if (field.checked) completed++;
                } else if (field.type === 'radio') {
                    const radioGroup = form.querySelectorAll(`[name="${field.name}"]`);
                    const isChecked = Array.from(radioGroup).some(r => r.checked);
                    if (isChecked) completed++;
                } else if (field.value && field.value.trim() !== '') {
                    completed++;
                }
            });

            const percentage = requiredFields.length > 0
                ? Math.round((completed / requiredFields.length) * 100)
                : 0;

            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '% Complete';
        }

        // Close modal when clicking outside
        document.getElementById('attestationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttestationModal();
            }
        });
    </script>
</body>
</html>

@* Helper classes for template configuration *@
@functions {
    public class TemplateConfig
    {
        public List<SectionConfig> Sections { get; set; } = new();
    }

    public class SectionConfig
    {
        public string SectionId { get; set; } = string.Empty;
        public string SectionTitle { get; set; } = string.Empty;
        public string? Disclaimer { get; set; }
        public int SectionOrder { get; set; }
        public List<FieldConfig> Fields { get; set; } = new();
    }

    public class FieldConfig
    {
        public string FieldId { get; set; } = string.Empty;
        public string FieldLabel { get; set; } = string.Empty;
        public string FieldType { get; set; } = string.Empty;
        public bool Required { get; set; }
        public int Order { get; set; }
        public string? ConditionalOn { get; set; }
        public List<string>? Options { get; set; }
    }
}
