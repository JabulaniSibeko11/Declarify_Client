@model Declarify.Models.ViewModels.ReviewSubmissionViewModel
@using System.Text.Json
@{
    Layout = null;

    // Parse template configuration with correct property mapping
    var templateConfig = !string.IsNullOrEmpty(Model.TemplateConfig)
        ? JsonSerializer.Deserialize<TemplateConfig>(Model.TemplateConfig, new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        })
        : new TemplateConfig();

    // Parse submitted form data
    var formData = !string.IsNullOrEmpty(Model.FormData)
        ? JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(Model.FormData)
        : new Dictionary<string, JsonElement>();

    // Parse the digital attestation if it exists
    var hasAttestation = !string.IsNullOrEmpty(Model.DigitalAttestation);
    Dictionary<string, JsonElement>? attestationData = null;

    if (hasAttestation)
    {
        try
        {
            attestationData = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(Model.DigitalAttestation);
        }
        catch { }
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Declaration - Declarify</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="~/css/completeformcss1.css" rel="stylesheet" />
    <link href="~/css/reviewcss.css" rel="stylesheet" />
</head>
<body>
    <!-- Hero Header -->
    <div class="hero-header">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">
                    Review & <span class="accent">Sign-Off</span>
                </h1>
                <p style="opacity: 0.9; font-size: 1.1rem;">
                    Declaration submitted by @Model.EmployeeName on @Model.SubmittedDate.ToString("MMMM dd, yyyy")
                </p>

                <div class="hero-meta">
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>@Model.SubmittedDate.ToString("MMMM dd, yyyy HH:mm")</span>
                    </div>
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="status-badge">@Model.SubmissionStatus</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Split Layout -->
    <div class="container review-container">
        <!-- Left Panel - Form with Answers (Disabled) -->
        <div class="form-panel">
            <!-- Welcome Banner -->
            <div class="welcome-banner">
                <span class="welcome-text">Reviewing submission from <strong>@Model.EmployeeName</strong></span>
            </div>

            <!-- Employee Details Section -->
            <div class="form-card user-details-card">
                <div class="section-header">
                    <span class="section-number user-icon">👤</span>
                    <span>Employee Details</span>
                </div>
                <div class="user-details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Full Name</div>
                        <div class="detail-value">@Model.EmployeeName</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Position</div>
                        <div class="detail-value">@Model.Position</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Department</div>
                        <div class="detail-value">@Model.Department</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Submission Date</div>
                        <div class="detail-value">@Model.SubmittedDate.ToString("MMM dd, yyyy HH:mm")</div>
                    </div>
                </div>
            </div>

            <!-- Form Sections with Submitted Data (All Disabled) -->
            @if (templateConfig?.Sections != null && templateConfig.Sections.Any())
            {
                var orderedSections = templateConfig.Sections.OrderBy(s => s.SectionOrder).ToList();

                for (int i = 0; i < orderedSections.Count; i++)
                {
                    var sec = orderedSections[i];
                    var sectionIndex = i + 1;

                    <div class="form-card" data-section="@sectionIndex" data-section-id="@sec.SectionId">
                        <div class="section-header">
                            <span class="section-number">@sectionIndex</span>
                            <span>@sec.SectionTitle</span>
                        </div>

                        @if (!string.IsNullOrEmpty(sec.Disclaimer))
                        {
                            <p class="section-description">@sec.Disclaimer</p>
                        }

                        @if (sec.Fields != null && sec.Fields.Any())
                        {
                            var orderedFields = sec.Fields.OrderBy(f => f.Order).ToList();

                            foreach (var field in orderedFields)
                            {
                                <div class="form-group" data-field-id="@field.FieldId">
                                    @switch (field.FieldType.ToLower())
                                    {
                                        case "heading":
                                            <h3 class="field-heading">@field.FieldLabel</h3>
                                            break;

                                        case "paragraph":
                                            <p class="field-paragraph">
                                                @(!string.IsNullOrWhiteSpace(field.HelpText) ? field.HelpText : field.FieldLabel)
                                            </p>
                                            break;

                                        case "divider":
                                            <hr class="field-divider" />
                                            break;

                                        case "text":
                                        case "email":
                                        case "number":
                                        case "phone":
                                        case "url":
                                            
                                                var textValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement textElement))
                                                {
                                                    textValue = textElement.ValueKind == JsonValueKind.String ? textElement.GetString() ?? "" : textElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            @if (!string.IsNullOrEmpty(field.HelpText))
                                            {
                                                <small style="display: block; margin-bottom: 8px; color: #6b7280;">@field.HelpText</small>
                                            }
                                            <input type="@field.FieldType" class="form-input" id="@field.FieldId" value="@textValue" disabled />
                                            break;

                                        case "currency":
                                           
                                                var currencyValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement currElement))
                                                {
                                                    currencyValue = currElement.ValueKind == JsonValueKind.String ? currElement.GetString() ?? "" : currElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <div style="position: relative;">
                                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">R</span>
                                                <input type="number" class="form-input" id="@field.FieldId" value="@currencyValue" step="0.01" style="padding-left: 32px;" disabled />
                                            </div>
                                            break;

                                        case "date":
                                            
                                                var dateValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement dateElement))
                                                {
                                                    dateValue = dateElement.ValueKind == JsonValueKind.String ? dateElement.GetString() ?? "" : dateElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <input type="date" class="form-input" id="@field.FieldId" value="@dateValue" disabled />
                                            break;

                                        case "textarea":
                                            
                                                var textareaValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement textareaElement))
                                                {
                                                    textareaValue = textareaElement.ValueKind == JsonValueKind.String ? textareaElement.GetString() ?? "" : textareaElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <textarea class="form-textarea" id="@field.FieldId" disabled>@textareaValue</textarea>
                                            break;

                                        case "select":
                                        case "dropdown":
                                            
                                                var selectValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement selectElement))
                                                {
                                                    selectValue = selectElement.ValueKind == JsonValueKind.String ? selectElement.GetString() ?? "" : selectElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <select class="form-select" id="@field.FieldId" disabled>
                                                <option value="">Select...</option>
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    foreach (var option in field.Options)
                                                    {
                                                        <option value="@option" selected="@(option == selectValue)">@option</option>
                                                    }
                                                }
                                            </select>
                                            break;

                                        case "checkbox":
                                            
                                                var isChecked = false;
                                                if (formData.TryGetValue(field.FieldId, out JsonElement checkElement))
                                                {
                                                    isChecked = checkElement.ValueKind == JsonValueKind.True || 
                                                               (checkElement.ValueKind == JsonValueKind.String && checkElement.GetString()?.ToLower() == "true");
                                                }
                                            
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="@field.FieldId" checked="@isChecked" disabled />
                                                    <label for="@field.FieldId">@field.FieldLabel</label>
                                                </div>
                                            </div>
                                            break;

                                        case "boolean":
                                            
                                                var boolValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement boolElement))
                                                {
                                                    boolValue = boolElement.ValueKind == JsonValueKind.String ? boolElement.GetString() ?? "" : boolElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" id="@($"{field.FieldId}-yes")" name="@field.FieldId" value="Yes" checked="@(boolValue == "Yes")" disabled />
                                                    <label for="@($"{field.FieldId}-yes")">Yes</label>
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" id="@($"{field.FieldId}-no")" name="@field.FieldId" value="No" checked="@(boolValue == "No")" disabled />
                                                    <label for="@($"{field.FieldId}-no")">No</label>
                                                </div>
                                            </div>
                                            break;

                                        case "radio":
                                            
                                                var radioValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement radioElement))
                                                {
                                                    radioValue = radioElement.ValueKind == JsonValueKind.String ? radioElement.GetString() ?? "" : radioElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            <div class="radio-group">
                                                @if (field.Options != null && field.Options.Any())
                                                {
                                                    for (int optIdx = 0; optIdx < field.Options.Count; optIdx++)
                                                    {
                                                        var option = field.Options[optIdx];
                                                        var radioId = $"{field.FieldId}_option{optIdx}";
                                                        <div class="radio-item">
                                                            <input type="radio" id="@radioId" name="@field.FieldId" value="@option" checked="@(option == radioValue)" disabled />
                                                            <label for="@radioId">@option</label>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            break;

                                        case "file":
                                            
                                                var fileValue = "";
                                                if (formData.TryGetValue(field.FieldId, out JsonElement fileElement))
                                                {
                                                    fileValue = fileElement.ValueKind == JsonValueKind.String ? fileElement.GetString() ?? "" : fileElement.ToString();
                                                }
                                            
                                            <label class="form-label @(field.Required ? "required" : "")" for="@field.FieldId">@field.FieldLabel</label>
                                            <input type="text" class="form-input" value="@(!string.IsNullOrEmpty(fileValue) ? fileValue : "No file uploaded")" disabled />
                                            break;

                                        case "table":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            @if (!string.IsNullOrEmpty(field.HelpText))
                                            {
                                                <small style="display: block; margin-bottom: 8px; color: #6b7280;">@field.HelpText</small>
                                            }

                                            <div class="table-field" data-table-id="@field.FieldId">
                                                <table id="table-@field.FieldId">
                                                    <thead>
                                                        <tr>
                                                            @{
                                                                var columns = field.TableConfig?.Columns?.Any() == true
                                                                ? field.TableConfig.Columns
                                                                : new List<string> { "Description", "Details", "Value" };

                                                                foreach (var column in columns)
                                                                {
                                                                    <th>@column</th>
                                                                }
                                                            }
                                                        </tr>
                                                    </thead>

                                                    <tbody id="tbody-@field.FieldId">
                                                        @{
                                                            // Collect all table data for this field
                                                            var tableData = formData.Where(kvp => kvp.Key.StartsWith(field.FieldId + "_row"))
                                                                                    .OrderBy(kvp => kvp.Key)
                                                                                    .ToList();

                                                            // Group by row
                                                            var rowGroups = tableData.GroupBy(kvp => {
                                                                var match = System.Text.RegularExpressions.Regex.Match(kvp.Key, @"_row(\d+)_");
                                                                return match.Success ? int.Parse(match.Groups[1].Value) : -1;
                                                            }).Where(g => g.Key >= 0).OrderBy(g => g.Key);

                                                            foreach (var rowGroup in rowGroups)
                                                            {
                                                                <tr class="table-row">
                                                                    @for (int colIdx = 0; colIdx < columns.Count; colIdx++)
                                                                    {
                                                                        var cellKey = $"{field.FieldId}_row{rowGroup.Key}_col{colIdx}";
                                                                        var cellValue = "";
                                                                        if (formData.TryGetValue(cellKey, out JsonElement cellElement))
                                                                        {
                                                                            cellValue = cellElement.ValueKind == JsonValueKind.String ? cellElement.GetString() ?? "" : cellElement.ToString();
                                                                        }
                                                                        <td>
                                                                            <input type="text" value="@cellValue" disabled />
                                                                        </td>
                                                                    }
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                            break;

                                        case "advancedtable":
                                            <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                            @if (!string.IsNullOrEmpty(field.HelpText))
                                            {
                                                <small style="display: block; margin-bottom: 8px; color: #6b7280;">@field.HelpText</small>
                                            }

                                            <div class="advanced-table-field" data-advanced-table-id="@field.FieldId">
                                                @{
                                                    var cells = field.Cells ?? new List<CellConfig>();
                                                    var visibleCells = cells.Where(c => !c.Hidden).OrderBy(c => c.Row).ThenBy(c => c.Col).ToList();
                                                    var totalRows = (field.Rows ?? 4);
                                                    var totalCols = (field.GridColumns ?? 3);
                                                    var headerRows = visibleCells.Where(c => c.IsHeader).GroupBy(c => c.Row).OrderBy(g => g.Key).ToList();
                                                    var firstDataRow = headerRows.Any() ? headerRows.Max(g => g.Key) + 1 : 0;
                                                    var assignedColumns = field.Columns ?? new List<ColumnConfig>();
                                                }

                                                <div class="advanced-table-container">
                                                    <table id="advTable-@field.FieldId">
                                                        <!-- Header rows -->
                                                        @foreach (var headerRowGroup in headerRows)
                                                        {
                                                            <tr>
                                                                @foreach (var cell in headerRowGroup.OrderBy(c => c.Col))
                                                                {
                                                                    <th class="header-cell"
                                                                        rowspan="@cell.Rowspan"
                                                                        colspan="@cell.Colspan">
                                                                        @(cell.ColumnName ?? "")
                                                                    </th>
                                                                }
                                                            </tr>
                                                        }

                                                        <!-- Data rows -->
                                                        <tbody id="advTbody-@field.FieldId">
                                                            @{
                                                                var dataEntryRow = visibleCells.Where(c => c.Row == 2 && !c.IsHeader).ToList();
                                                                
                                                                // Collect all advanced table data
                                                                var advTableData = formData.Where(kvp => kvp.Key.StartsWith(field.FieldId + "_datarow"))
                                                                                           .OrderBy(kvp => kvp.Key)
                                                                                           .ToList();

                                                                var advRowGroups = advTableData.GroupBy(kvp => {
                                                                    var match = System.Text.RegularExpressions.Regex.Match(kvp.Key, @"_datarow(\d+)_");
                                                                    return match.Success ? int.Parse(match.Groups[1].Value) : -1;
                                                                }).Where(g => g.Key >= 0).OrderBy(g => g.Key);

                                                                foreach (var advRowGroup in advRowGroups)
                                                                {
                                                                    <tr class="advanced-table-data-row">
                                                                        @for (int col = 0; col < totalCols; col++)
                                                                        {
                                                                            var templateCell = dataEntryRow.FirstOrDefault(c => c.Col == col);
                                                                            if (templateCell != null)
                                                                            {
                                                                                var column = assignedColumns.FirstOrDefault(c => c.Name == templateCell.ColumnName);
                                                                                var inputType = "text";

                                                                                if (column != null)
                                                                                {
                                                                                    inputType = column.Type?.ToLower() switch
                                                                                    {
                                                                                        "number" => "number",
                                                                                        "date" => "date",
                                                                                        "email" => "email",
                                                                                        _ => "text"
                                                                                    };
                                                                                }

                                                                                var cellKey = $"{field.FieldId}_datarow{advRowGroup.Key}_col{col}";
                                                                                var cellValue = "";
                                                                                if (formData.TryGetValue(cellKey, out JsonElement advCellElement))
                                                                                {
                                                                                    cellValue = advCellElement.ValueKind == JsonValueKind.String ? advCellElement.GetString() ?? "" : advCellElement.ToString();
                                                                                }

                                                                                <td class="assigned-cell">
                                                                                    <input type="@inputType" value="@cellValue" disabled />
                                                                                </td>
                                                                            }
                                                                        }
                                                                    </tr>
                                                                }
                                                            }
                                                        </tbody>

                                                        <!-- Fixed footer rows -->
                                                        @{
                                                            var footerRows = visibleCells.Where(c => c.Row >= 3 && !c.IsHeader)
                                                                                         .GroupBy(c => c.Row)
                                                                                         .OrderBy(g => g.Key)
                                                                                         .ToList();

                                                            foreach (var footerRowGroup in footerRows)
                                                            {
                                                                <tr class="advanced-table-footer-row">
                                                                    @foreach (var cell in footerRowGroup.OrderBy(c => c.Col))
                                                                    {
                                                                        var column = assignedColumns.FirstOrDefault(c => c.Name == cell.ColumnName);
                                                                        var inputType = "text";

                                                                        if (column != null)
                                                                        {
                                                                            inputType = column.Type?.ToLower() switch
                                                                            {
                                                                                "number" => "number",
                                                                                "date" => "date",
                                                                                "email" => "email",
                                                                                _ => "text"
                                                                            };
                                                                        }

                                                                        var fixedCellKey = $"{field.FieldId}_fixedrow{cell.Row}_col{cell.Col}";
                                                                        var fixedCellValue = "";
                                                                        if (formData.TryGetValue(fixedCellKey, out JsonElement fixedElement))
                                                                        {
                                                                            fixedCellValue = fixedElement.ValueKind == JsonValueKind.String ? fixedElement.GetString() ?? "" : fixedElement.ToString();
                                                                        }

                                                                        <td class="assigned-cell"
                                                                            rowspan="@cell.Rowspan"
                                                                            colspan="@cell.Colspan">
                                                                            <strong>@cell.ColumnName</strong>
                                                                            <input type="@inputType" value="@fixedCellValue" style="margin-top: 8px;" disabled />
                                                                        </td>
                                                                    }
                                                                </tr>
                                                            }
                                                        }
                                                    </table>
                                                </div>
                                            </div>
                                            break;

                                           case "signature":
                                               
                                                    var signatureValue = "";
                                                    if (formData.TryGetValue(field.FieldId, out JsonElement sigElement))
                                                    {
                                                        signatureValue = sigElement.ValueKind == JsonValueKind.String ? sigElement.GetString() ?? "" : sigElement.ToString();
                                                    }
                                                    // If no signature in form data, fall back to employee signature from model
                                                    if (string.IsNullOrEmpty(signatureValue))
                                                    {
                                                        signatureValue = Model.EmployeeSignature;
                                                    }
                                                
                                                <label class="form-label @(field.Required ? "required" : "")">@field.FieldLabel</label>
                                                <div class="signature-field">
                                                    <p style="margin: 0 0 12px 0; color: #6b7280;">Employee signature</p>
                                                    <div class="signature-pad">
                                                        @if (!string.IsNullOrEmpty(signatureValue))
                                                        {
                                                            <img src="@signatureValue" alt="Employee Signature" style="max-height: 100px;" />
                                                        }
                                                        else
                                                        {
                                                            <span style="color: #9ca3af;">No signature provided</span>
                                                        }
                                                    </div>
                                                </div>
                                                break;
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            }

            <!-- Digital Attestation Display -->
            @if (hasAttestation && attestationData != null)
            {
                <div class="attestation-display">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2c1.821 0 3.532.448 5.047 1.238" />
                        </svg>
                        Employee Digital Attestation
                    </h3>

                    <div class="attestation-text">
                        <strong>Employee Declaration:</strong><br>
                        "@Model.EmployeeName declares that the information provided above is true, complete, and accurate to the best of their knowledge."
                    </div>

                    @if (attestationData.TryGetValue("signature", out var signatureElement))
                    {
                        var signatureData = signatureElement.GetString();
                        if (!string.IsNullOrEmpty(signatureData))
                        {
                            <div class="signature-container">
                                <img src="@signatureData" alt="Employee Signature" class="signature-image" />
                                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">
                                    Digitally signed on: @Model.SubmittedDate.ToString("MMMM dd, yyyy 'at' HH:mm")
                                </p>
                            </div>
                        }
                    }
                </div>
            }
        </div>

        <!-- Right Panel - Review Actions -->
        <div class="actions-panel">
            <h2 class="actions-title">Review Actions</h2>

            <div class="status-indicator">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Awaiting Your Review
            </div>

            <div class="alert-box warning">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <div>
                    <strong>Important:</strong> Review all information carefully before making a decision. Your action will be recorded with a timestamp and digital signature.
                </div>
            </div>

            <!-- Action Buttons -->
            <button type="button" class="action-btn btn-approve" onclick="showApprovalModal()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Approve Declaration</span>
            </button>

            <button type="button" class="action-btn btn-reject" onclick="showRejectionModal()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Request Revision</span>
            </button>

            <button type="button" class="action-btn btn-verification" onclick="showVerificationModal()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2c1.821 0 3.532.448 5.047 1.238" />
                </svg>
                <span>Request Verification</span>
            </button>

            <a href="@Url.Action("Dashboard", "Employee")" class="action-btn" style="background: white; border: 2px solid #00C2CB; color: #00C2CB; text-decoration: none;">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Back to Dashboard</span>
            </a>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal-overlay" id="approvalModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon approve">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="modal-title">Approve Declaration</h2>
                    <p class="modal-subtitle">Provide your approval notes</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="alert-box info">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <strong>Step 1 of 2:</strong> Provide approval notes, then you'll be asked to digitally sign your review.
                    </div>
                </div>

                <label class="form-label" for="approvalNotes">Approval Notes (Optional)</label>
                <textarea id="approvalNotes" class="modal-textarea" placeholder="Add any comments or observations about this submission..."></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="closeModal('approvalModal')">Cancel</button>
                <button type="button" class="btn-modal btn-modal-confirm" onclick="proceedToAttestation('approve')">
                    Next: Digital Signature →
                </button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div class="modal-overlay" id="rejectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon reject">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="modal-title">Request Revision</h2>
                    <p class="modal-subtitle">Provide detailed feedback for the employee</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="alert-box warning">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                    <div>
                        <strong>Step 1 of 2:</strong> Explain what needs correction, then you'll digitally sign your review decision.
                    </div>
                </div>

                <label class="form-label required" for="rejectionNotes">Revision Notes</label>
                <textarea id="rejectionNotes" class="modal-textarea" placeholder="Explain what needs to be corrected or added..." required></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="closeModal('rejectionModal')">Cancel</button>
                <button type="button" class="btn-modal btn-modal-confirm" style="background: #ef4444; color: white;" onclick="proceedToAttestation('reject')">
                    Next: Digital Signature →
                </button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal-overlay" id="verificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon verification">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2c1.821 0 3.532.448 5.047 1.238" />
                        </svg>
                    </div>
                    <h2 class="modal-title">Request External Verification</h2>
                    <p class="modal-subtitle">Flag this submission for compliance verification</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="alert-box info">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <strong>Step 1 of 2:</strong> Explain why verification is needed (CIPC checks, credit worthiness, etc.), then digitally sign your request.
                    </div>
                </div>

                <label class="form-label required" for="verificationNotes">Reason for Verification Request</label>
                <textarea id="verificationNotes" class="modal-textarea" placeholder="Explain why this submission requires external verification..." required></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="closeModal('verificationModal')">Cancel</button>
                <button type="button" class="btn-modal btn-modal-confirm" onclick="proceedToAttestation('verification')">
                    Next: Digital Signature →
                </button>
            </div>
        </div>
    </div>

    <!-- Digital Attestation Modal -->
    <div class="modal-overlay" id="attestationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon" id="attestationIcon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0121 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2c1.821 0 3.532.448 5.047 1.238" />
                        </svg>
                    </div>
                    <h2 class="modal-title">Digital Attestation & Signature</h2>
                    <p class="modal-subtitle">Confirm and sign your review decision</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="alert-box info">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <strong>Final Step:</strong> Your digital signature certifies that you have reviewed the declaration and your decision is based on accurate assessment.
                    </div>
                </div>

                <!-- Reviewer Info -->
                <div class="reviewer-info">
                    <div class="info-row">
                        <span class="info-label">Reviewer Name:</span>
                        <span class="info-value">@Model.ReviewerName</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Position:</span>
                        <span class="info-value">@Model.ReviewerPosition</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Review Date:</span>
                        <span class="info-value" id="reviewDate"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Decision:</span>
                        <span class="info-value" id="reviewDecision"></span>
                    </div>
                </div>

                <!-- Auto-loaded Signature Display -->
                <div style="margin-top: 1.5rem;">
                    <label class="form-label required">Your Digital Signature (Auto-loaded)</label>
                    <div class="signature-display-box">
                        <img id="reviewerSignatureImage" src="@Model.ReviewerSignature" alt="Reviewer Signature" class="signature-image" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" />
                    </div>
                    <p style="text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 0.75rem;">
                        <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Signature loaded from your profile
                    </p>
                </div>

                <!-- Attestation Checkbox -->
                <div class="attestation-checkbox">
                    <input type="checkbox" id="attestationCheck" required />
                    <label for="attestationCheck">
                        <strong>I certify that:</strong> I have thoroughly reviewed this declaration, my decision is based on accurate assessment, and I understand this digital signature has the same legal effect as a handwritten signature.
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="backToNotesModal()">← Back</button>
                <button type="button" class="btn-modal btn-modal-confirm" id="finalSubmitBtn" onclick="finalSubmit()" disabled>
                    ✓ Confirm & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Global variables
        let currentAction = '';
        let reviewerSignatureData = '@Model.ReviewerSignature';

        // Modal Functions
        function showApprovalModal() {
            document.getElementById('approvalModal').classList.add('active');
        }

        function showRejectionModal() {
            document.getElementById('rejectionModal').classList.add('active');
        }

        function showVerificationModal() {
            document.getElementById('verificationModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function proceedToAttestation(action) {
            // Validate notes based on action
            if (action === 'reject') {
                const notes = document.getElementById('rejectionNotes').value.trim();
                if (!notes) {
                    alert('Please provide revision notes before proceeding.');
                    return;
                }
            } else if (action === 'verification') {
                const notes = document.getElementById('verificationNotes').value.trim();
                if (!notes) {
                    alert('Please provide a reason for verification before proceeding.');
                    return;
                }
            }

            // Store current action
            currentAction = action;

            // Close current modal
            closeModal('approvalModal');
            closeModal('rejectionModal');
            closeModal('verificationModal');

            // Update attestation modal based on action
            const attestationIcon = document.getElementById('attestationIcon');
            const reviewDecision = document.getElementById('reviewDecision');

            attestationIcon.className = 'modal-icon ' + action;

            if (action === 'approve') {
                reviewDecision.textContent = 'APPROVED';
                reviewDecision.style.color = '#10b981';
            } else if (action === 'reject') {
                reviewDecision.textContent = 'REVISION REQUIRED';
                reviewDecision.style.color = '#ef4444';
            } else if (action === 'verification') {
                reviewDecision.textContent = 'VERIFICATION REQUESTED';
                reviewDecision.style.color = '#00C2CB';
            }

            // Set review date
            document.getElementById('reviewDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Reset checkbox
            document.getElementById('attestationCheck').checked = false;
            document.getElementById('finalSubmitBtn').disabled = true;

            // Show attestation modal
            document.getElementById('attestationModal').classList.add('active');
        }

        function backToNotesModal() {
            closeModal('attestationModal');

            if (currentAction === 'approve') {
                showApprovalModal();
            } else if (currentAction === 'reject') {
                showRejectionModal();
            } else if (currentAction === 'verification') {
                showVerificationModal();
            }
        }

        async function finalSubmit() {
            let reviewerNotes = '';
            let verificationType = null;

            // Get notes based on action
            if (currentAction === 'approve') {
                reviewerNotes = document.getElementById('approvalNotes').value.trim();
            } else if (currentAction === 'reject') {
                reviewerNotes = document.getElementById('rejectionNotes').value.trim();
            } else if (currentAction === 'verification') {
                reviewerNotes = document.getElementById('verificationNotes').value.trim();
                verificationType = 'Manual Review Request';
            }

            const payload = {
                submissionId: @Model.SubmissionId,
                action: currentAction,
                reviewerNotes: reviewerNotes,
                reviewerName: '@Model.ReviewerName',
                reviewerPosition: '@Model.ReviewerPosition',
                verificationType: verificationType,
                reviewerSignature: reviewerSignatureData
            };

            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            closeModal('attestationModal');

            try {
                const response = await fetch('@Url.Action("ProcessReview", "Employee")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirectUrl || '@Url.Action("Dashboard", "Employee")';
                } else {
                    document.getElementById('loadingOverlay').classList.remove('active');
                    alert(result.message || 'An error occurred. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('An error occurred. Please try again.');
            }
        }

        // Enable/disable submit button based on checkbox
        document.getElementById('attestationCheck').addEventListener('change', function () {
            const submitBtn = document.getElementById('finalSubmitBtn');
            submitBtn.disabled = !this.checked;
        });

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });
    </script>
</body>
</html>

@* Helper classes for template configuration *@
@functions {
    public class TemplateConfig
    {
        public List<SectionConfig> Sections { get; set; } = new();
    }

    public class SectionConfig
    {
        public string SectionId { get; set; } = string.Empty;
        public string SectionTitle { get; set; } = string.Empty;
        public string? Disclaimer { get; set; }
        public int SectionOrder { get; set; }
        public List<FieldConfig> Fields { get; set; } = new();
    }

    public class FieldConfig
    {
        public string FieldId { get; set; } = string.Empty;
        public string FieldLabel { get; set; } = string.Empty;
        public string FieldType { get; set; } = string.Empty;
        public bool Required { get; set; }
        public int Order { get; set; }
        public string? ConditionalOn { get; set; }
        public List<string>? Options { get; set; }
        public string? Placeholder { get; set; }
        public string? HelpText { get; set; }
        public TableConfig? TableConfig { get; set; }
        public List<ColumnConfig>? Columns { get; set; }
        public int? Rows { get; set; }
        public int? GridColumns { get; set; }
        public List<CellConfig>? Cells { get; set; }
        public ValidationConfig? Validation { get; set; }
    }

    public class TableConfig
    {
        public List<string> Columns { get; set; } = new();
        public int MinRows { get; set; }
        public bool AllowAddRows { get; set; }
    }

    public class ColumnConfig
    {
        public string? Name { get; set; }
        public string Type { get; set; }
    }

    public class CellConfig
    {
        public int Row { get; set; }
        public int Col { get; set; }
        public int Rowspan { get; set; }
        public int Colspan { get; set; }
        public string? ColumnId { get; set; }
        public string? ColumnName { get; set; }
        public bool IsHeader { get; set; }
        public bool IsMerged { get; set; }
        public bool Hidden { get; set; }
    }

    public class ValidationConfig
    {
        public string? Min { get; set; }
        public string? Max { get; set; }
        public string? FileTypes { get; set; }
        public int? MaxSize { get; set; }
        public bool? AllowTyped { get; set; }
    }
}
