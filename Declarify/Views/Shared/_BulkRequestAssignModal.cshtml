@model Declarify.Models.ViewModels.DashboardViewModel

<!-- Bulk Request Modal (FR 4.3.1) -->
<div id="bulkRequestModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                </div>
                <div>
                    <h2 class="modal-title">Create Bulk DOI Request</h2>
                    <p class="modal-subtitle">Send declaration forms to selected employees with a specified due date</p>
                </div>
            </div>
            <button type="button" class="modal-close" onclick="closeBulkRequestModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="bulkRequestForm" method="post" action="@Url.Action("BulkRequest", "Home")">
            @Html.AntiForgeryToken()

            <div class="modal-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Select Template</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Choose Employees</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Set Due Date</div>
                    </div>
                </div>

                <!-- Step 1: Template Selection -->
                <div class="form-step" id="step1" style="display: block;">
                    <div class="form-section">
                        <label class="form-label">
                            <span class="label-text">Declaration Template</span>
                            <span class="label-required">*</span>
                        </label>
                        <p class="form-help">Select the DOI template that employees will complete</p>

                        <div class="template-grid">
                            @if (Model?.BulkData?.Templates != null && Model.BulkData.Templates.Any())
                            {
                                @foreach (var template in Model.BulkData.Templates)
                                {
                                    <div class="template-card" onclick="selectTemplate(@template.TemplateId, '@template.TemplateName')">
                                        <input type="radio"
                                               name="TemplateId"
                                               id="template_@template.TemplateId"
                                               value="@template.TemplateId"
                                               class="template-radio"
                                               required />
                                        <label for="template_@template.TemplateId" class="template-card-content">
                                            <div class="template-card-header">
                                                <div class="template-icon">
                                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                </div>
                                                <span class="template-badge">Active</span>
                                            </div>
                                            <h3 class="template-name">@template.TemplateName</h3>
                                            <p class="template-description">@(template.Description ?? "Standard declaration of interest form")</p>
                                            <div class="template-meta">
                                                <span class="meta-item">
                                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    @* Version @template.Version *@
                                                </span>
                                            </div>
                                        </label>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-state">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p>No active templates available. Create a template first.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Step 2: Employee Selection -->
                <div class="form-step" id="step2" style="display: none;">
                    <div class="form-section">
                        <label class="form-label">
                            <span class="label-text">Employee Selection</span>
                            <span class="label-required">*</span>
                        </label>
                        <p class="form-help">Choose employees who must complete this declaration</p>

                        <!-- Selection Strategy Tabs -->
                        <div class="selection-tabs">
                            <button type="button" class="tab-button active" onclick="switchSelectionMode('individual')" data-mode="individual">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                Individual Selection
                            </button>
                            <button type="button" class="tab-button" onclick="switchSelectionMode('department')" data-mode="department">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                By Department
                            </button>
                            <button type="button" class="tab-button" onclick="selectAllEmployees()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Select All
                            </button>
                        </div>

                        <!-- Individual Selection View -->
                        <div id="individualSelection" class="selection-content">
                            <div class="search-box">
                                <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="11" cy="11" r="8" />
                                    <path d="M21 21l-4.35-4.35" />
                                </svg>
                                <input type="text"
                                       id="employeeSearch"
                                       class="search-input"
                                       placeholder="Search by name, email, or employee ID..."
                                       onkeyup="filterEmployees()" />
                            </div>

                            <div class="selection-summary">
                                <span class="summary-text">
                                    <span id="selectedCount">0</span> of <span id="totalCount">@(Model?.BulkData?.Employees?.Count() ?? 0)</span> employees selected
                                </span>
                                <button type="button" class="btn-link" onclick="clearSelection()">Clear Selection</button>
                            </div>

                            <div class="employee-list" id="employeeList">
                                @if (Model?.BulkData?.Employees != null && Model.BulkData.Employees.Any())
                                {
                                    @foreach (var employee in Model.BulkData.Employees)
                                    {
                                        <div class="employee-item" data-employee-id="@employee.EmployeeId"
                                             data-name="@employee.Full_Name?.ToLower()"
                                             data-email="@employee.Email_Address?.ToLower()"
                                             data-dept="@employee.Department.?ToLower()">
                                            <label class="employee-checkbox">
                                                <input type="checkbox"
                                                       name="EmployeeIds"
                                                       value="@employee.EmployeeId"
                                                       class="employee-check"
                                                       onchange="updateSelectionCount()" />
                                                <div class="employee-info">
                                                    <div class="employee-avatar">
                                                        @employee.Full_Name.?Substring(0, Math.Min(2, employee.Full_Name.Length)).ToUpper()
                                                    </div>
                                                    <div class="employee-details">
                                                        <div class="employee-name">@employee.Full_Name</div>
                                                        <div class="employee-meta">
                                                            <span class="meta-item">@employee.Email_Address</span>
                                                            <span class="meta-divider">•</span>
                                                            <span class="meta-item">@employee.Department</span>
                                                            <span class="meta-divider">•</span>
                                                            <span class="meta-item">ID: @employee.EmployeeNumber</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                        </svg>
                                        <p>No employees found. Import employees first.</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Department Selection View -->
                        <div id="departmentSelection" class="selection-content" style="display: none;">
                            <div class="department-grid">
                                @if (Model?.BulkData?.Departments != null && Model.BulkData.Departments.Any())
                                {
                                    @foreach (var dept in Model.BulkData.Departments)
                                    {
                                        <div class="department-select-card">
                                            <label class="department-checkbox">
                                                <input type="checkbox"
                                                       class="dept-check"
                                                       data-department="@dept.Key"
                                                       onchange="selectDepartment(this)" />
                                                <div class="dept-card-content">
                                                    <div class="dept-icon">
                                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                            <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                                        </svg>
                                                    </div>
                                                    <h4 class="dept-name">@dept.Key</h4>
                                                    <p class="dept-count">@dept.Value employee@(dept.Value != 1 ? "s" : "")</p>
                                                </div>
                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        <!-- Hidden field to store selected employee IDs as JSON -->
                       @*  <input type="hidden" name="EmployeeIdsJson" id="employeeIdsJson" /> *@
                        <input type="hidden" name="EmployeeIdsJson" id="employeeIdsHidden" />
                    </div>
                </div>

                <!-- Step 3: Due Date -->
                <div class="form-step" id="step3" style="display: none;">
                    <div class="form-section">
                        <label class="form-label" for="dueDate">
                            <span class="label-text">Due Date</span>
                            <span class="label-required">*</span>
                        </label>
                        <p class="form-help">Deadline for employees to submit their declarations</p>

                        <div class="date-input-wrapper">
                            <svg class="date-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                <line x1="16" y1="2" x2="16" y2="6" />
                                <line x1="8" y1="2" x2="8" y2="6" />
                                <line x1="3" y1="10" x2="21" y2="10" />
                            </svg>
                            <input type="date"
                                   id="dueDate"
                                   name="DueDate"
                                   class="date-input"
                                   value="@Model?.BulkData.SuggestedDueDate.ToString("yyyy-MM-dd")"
                                   min="@DateTime.UtcNow.AddDays(1).ToString("yyyy-MM-dd")"
                                   required />
                        </div>

                        <div class="quick-dates">
                            <button type="button" class="quick-date-btn" onclick="setQuickDate(7)">7 days</button>
                            <button type="button" class="quick-date-btn" onclick="setQuickDate(14)">14 days</button>
                            <button type="button" class="quick-date-btn" onclick="setQuickDate(30)">30 days</button>
                            <button type="button" class="quick-date-btn" onclick="setQuickDate(60)">60 days</button>
                        </div>

                        <!-- Summary Preview -->
                        <div class="summary-preview">
                            <h3 class="summary-title">Request Summary</h3>
                            <div class="summary-items">
                                <div class="summary-item">
                                    <span class="summary-label">Template:</span>
                                    <span class="summary-value" id="summaryTemplate">Not selected</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Employees:</span>
                                    <span class="summary-value" id="summaryEmployees">0 selected</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Due Date:</span>
                                    <span class="summary-value" id="summaryDueDate">@Model?.BulkData.SuggestedDueDate.ToString("MMMM d, yyyy")</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Reminders:</span>
                                    <span class="summary-value">7 days before & on due date</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M15 19l-7-7 7-7" />
                    </svg>
                    Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                    Next
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" />
                    </svg>
                    Send Requests
                </button>
            </div>
        </form>
    </div>
</div>
<input type="hidden" name="EmployeeIdsJson" id="employeeIdsHidden" />