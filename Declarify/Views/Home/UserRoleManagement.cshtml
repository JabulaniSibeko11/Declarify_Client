@model Declarify.Models.ViewModels.UserRoleManagementViewModel

@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Role Management - Declarify</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
<link href="~/css/settingcss1.css" rel="stylesheet" />
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <a href="@Url.Action("Index", "Home")" class="back-button">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <div class="brand">
                    <div class="brand-icon">
                        <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="brand-title">User Role & Manager Management</h1>
                        <p class="brand-subtitle">Assign roles, manage reporting lines & delegate manager responsibilities</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="openBulkReassignModal()" style="margin-right: 1rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span>Bulk Reassign</span>
                </button>
                <button class="btn btn-primary" onclick="saveAllChanges()" id="saveChangesBtn" style="display: none;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Save Changes</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-error">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <div class="hero-badge">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Admin Control Panel</span>
                </div>
                <h2 class="hero-title">Manage Roles & Reporting Lines</h2>
                <p class="hero-description">
                    Grant administrative access, assign managers, and delegate responsibilities when managers are absent. 
                    Essential for maintaining DOI compliance workflows.
                </p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card admin-stat">
                    <div class="stat-icon-wrapper admin-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.AdminCount</div>
                        <div class="stat-label">System Admins</div>
                        <div class="stat-description">Full system access</div>
                    </div>
                </div>

                <div class="stat-card executive-stat">
                    <div class="stat-icon-wrapper executive-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.ExecutiveCount</div>
                        <div class="stat-label">Executives</div>
                        <div class="stat-description">View-only access</div>
                    </div>
                </div>

                <div class="stat-card employee-stat">
                    <div class="stat-icon-wrapper employee-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.EmployeeCount</div>
                        <div class="stat-label">Employees</div>
                        <div class="stat-description">Standard users</div>
                    </div>
                </div>

                <div class="stat-card total-stat">
                    <div class="stat-icon-wrapper total-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.TotalUsers</div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-description">Active in system</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="controls-section">
            <div class="search-container">
                <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" 
                       id="userSearch" 
                       class="search-input" 
                       placeholder="Search by name, email, department, or position..."
                       autocomplete="off" />
            </div>
            <div class="filter-group">
                <select id="roleFilter" class="filter-select">
                    <option value="">All Roles</option>
                    <option value="Admin">Admins Only</option>
                    <option value="Executive">Executives Only</option>
                    <option value="Employee">Employees Only</option>
                </select>
                <select id="departmentFilter" class="filter-select">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Users.Select(u => u.Department).Distinct().OrderBy(d => d))
                    {
                        <option value="@dept">@dept</option>
                    }
                </select>
                <select id="managerFilter" class="filter-select">
                    <option value="">All Managers</option>
                    <option value="has-manager">Has Manager</option>
                    <option value="no-manager">No Manager</option>
                </select>
            </div>
        </div>

        <!-- Users Grid -->
        <div class="users-grid" id="usersGrid">
            @foreach (var user in Model.Users)
            {
                <div class="user-card" 
                     data-user-id="@user.UserId"
                     data-employee-id="@user.EmployeeId"
                     data-full-name="@user.FullName.ToLower()"
                     data-email="@user.Email.ToLower()"
                     data-department="@user.Department.ToLower()"
                     data-position="@user.Position.ToLower()"
                     data-role="@user.CurrentRole"
                     data-current-manager-id="@(user.CurrentManagerId ?? 0)"
                     data-current-manager-name="@(user.CurrentManagerName ?? "")">
                    
                    <!-- Card Header -->
                    <div class="user-card-header">
                        <div class="user-avatar-section">
                            <div class="user-avatar">
                                @{
                                    var initials = user.FullName.Split(' ').Length >= 2 
                                        ? user.FullName.Split(' ')[0].Substring(0, 1) + user.FullName.Split(' ').Last().Substring(0, 1)
                                        : user.FullName.Substring(0, Math.Min(2, user.FullName.Length));
                                }
                                @initials.ToUpper()
                            </div>
                            <div class="user-status-indicator"></div>
                        </div>
                        <div class="role-badge-container">
                            <span class="role-badge @user.CurrentRole.ToLower()">
                                @user.CurrentRole
                            </span>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="user-card-body">
                        <h3 class="user-name">@user.FullName</h3>
                        <p class="user-email">@user.Email</p>
                        
                        <div class="user-details">
                            <div class="user-detail-item">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <span>@user.Position</span>
                            </div>
                            <div class="user-detail-item">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                <span>@user.Department</span>
                            </div>
                            @if (user.LastLogin.HasValue)
                            {
                                <div class="user-detail-item">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>@user.LastLogin.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                        </div>

                        <!-- Current Manager Display -->
                        <div class="current-manager-section">
                            <div class="manager-label">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span>Reports To:</span>
                            </div>
                            <div class="manager-display" id="managerDisplay_@user.UserId">
                                @if (!string.IsNullOrEmpty(user.CurrentManagerName))
                                {
                                    <span class="manager-name">@user.CurrentManagerName</span>
                                }
                                else
                                {
                                    <span class="no-manager">No manager assigned</span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Card Footer -->
                    <div class="user-card-footer">
                        <div class="footer-section">
                            <label class="role-selector-label">Assign Role:</label>
                            <select class="role-selector" 
                                    data-user-id="@user.UserId" 
                                    data-original-role="@user.CurrentRole"
                                    onchange="handleRoleChange(this)">
                                <option value="Employee">Employee</option>
                                <option value="Executive">Executive</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>

                        <div class="footer-section">
                            <label class="role-selector-label">Assign Manager:</label>
                            <button class="btn-assign-manager" onclick="openManagerAssignModal('@user.UserId', '@user.EmployeeId', '@user.FullName')">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                </svg>
                                <span>Change Manager</span>
                            </button>
                        </div>
                    </div>

                    <!-- Change Indicator -->
                    <div class="change-indicator" style="display: none;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span>Unsaved Changes</span>
                    </div>
                </div>
            }
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="noResults" style="display: none;">
            <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3>No Users Found</h3>
            <p>Try adjusting your search or filter criteria</p>
        </div>
    </main>

    <!-- Manager Assignment Modal -->
    <div class="modal-overlay" id="managerAssignModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="modal-title">Assign Manager</h2>
                        <p class="modal-subtitle" id="modalSubtitle">Select a new manager for this employee</p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeManagerAssignModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="manager-search-container">
                    <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" 
                           id="managerSearch" 
                           class="modal-search-input" 
                           placeholder="Search managers by name or department..."
                           autocomplete="off" />
                </div>

                <div class="manager-list" id="managerList">
                    <!-- Managers will be populated here -->
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeManagerAssignModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Reassign Modal -->
    <div class="modal-overlay" id="bulkReassignModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="modal-title">Bulk Manager Reassignment</h2>
                        <p class="modal-subtitle">Reassign all employees from one manager to another</p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeBulkReassignModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="bulk-reassign-form">
                    <div class="form-group-modal">
                        <label class="modal-label">From Manager (Currently Away):</label>
                        <select id="fromManager" class="modal-select">
                            <option value="">Select manager...</option>
                            @foreach (var manager in Model.Users.Where(u => Model.Users.Any(e => e.CurrentManagerId == u.EmployeeId)).OrderBy(u => u.FullName))
                            {
                                <option value="@manager.EmployeeId" data-name="@manager.FullName">
                                    @manager.FullName - @manager.Position (@manager.Department)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="form-group-modal">
                        <label class="modal-label">To Manager (Temporary Delegate):</label>
                        <select id="toManager" class="modal-select">
                            <option value="">Select manager...</option>
                            @foreach (var manager in Model.Users.OrderBy(u => u.FullName))
                            {
                                <option value="@manager.EmployeeId">
                                    @manager.FullName - @manager.Position (@manager.Department)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="affected-employees-preview" id="affectedEmployeesPreview" style="display: none;">
                        <div class="preview-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="affectedCount">0 employees</span> will be reassigned
                        </div>
                        <div class="preview-list" id="affectedEmployeesList"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeBulkReassignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmBulkReassignment()" id="bulkReassignBtn" disabled>
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Reassign Employees</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Save Button -->
    <div class="floating-save-button" id="floatingSaveBtn" style="display: none;">
        <button class="btn btn-primary btn-lg" onclick="saveAllChanges()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            <span id="floatingSaveText">Save Changes</span>
        </button>
    </div>

    @Html.AntiForgeryToken()
    <script src="~/js/settingsjs.js"></script>
    <script>
        // Pass server-side URLs and data to JavaScript
        window.updateUserRolesUrl = '@Url.Action("UpdateUserRoles", "Home")';
        window.assignManagerUrl = '@Url.Action("AssignManager", "Home")';
        window.bulkReassignManagerUrl = '@Url.Action("BulkReassignManager", "Home")';
        
        // Pass all users data to JavaScript for manager selection
        window.allUsersData = @Html.Raw(Json.Serialize(Model.Users.Select(u => new {
            userId = u.UserId,
            employeeId = u.EmployeeId,
            fullName = u.FullName,
            email = u.Email,
            position = u.Position,
            department = u.Department,
            currentRole = u.CurrentRole,
            currentManagerId = u.CurrentManagerId,
            currentManagerName = u.CurrentManagerName
        })));
    </script>
    
   
</body>
</html>
