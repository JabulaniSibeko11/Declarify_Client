@model Declarify.Models.ViewModels.EmployeeDetailsViewModel

@{
    ViewData["Title"] = $"{Model.Employee.Full_Name} - Employee Profile";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Declarify</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    @* <link href="~/css/admindashboardcss.css" rel="stylesheet" /> *@
    <link href="~/css/employeedetailscss.css" rel="stylesheet" />
   <style>
        .modal-backdrop.show {
            backdrop-filter: blur(6px);
            background-color: rgba(0, 0, 0, 0.3);
        }

        .modal-custom {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-header.modal-danger {
            background-color: #fee2e2; /* light red */
            color: #b91c1c; /* dark red text */
        }
/* Status badge styling */
.status-badge.success {
    background: rgba(16, 185, 129, 0.15);
    color: #059669;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
}
      .status-badge.danger {
    background: rgba(239, 68, 68, 0.15);
    color: #DC2626;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
}
        

            .modal-form .status-badge.success {
                background: rgba(16, 185, 129, 0.15);
                color: #059669;
            }

            .modal-form .status-badge.danger {
                background: rgba(239, 68, 68, 0.15);
                color: #DC2626;
            }

        /* Modal Paragraph Styling */
        .modal-form p {
            font-size: 1rem;
            color: var(--color-text-main);
            margin-bottom: 1rem;
        }

        /* Adjust modal width for status content */
        .modal-container {
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            padding: 0;
            overflow: hidden;
        }

        .employee-card.inactive {
            opacity: 0.5;
            filter: grayscale(0.6);
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .status-badge.inactive {
            background: rgba(239, 68, 68, 0.15);
            color: #DC2626;
        }

   </style>
    <style>

        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #F8FAFC;
            border: 2px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1E293B;
            transition: all 0.3s ease;
            text-decoration: none;
        }

            .back-button:hover {
                background: #00C2CB;
                border-color: #00C2CB;
                color: white;
                transform: translateX(-3px);
            }

    </style>

</head>
<body>
    <!-- Header -->
    <header class="modern-header">
        <div class="header-container">
            <div class="brand-logo">
                <div class="logo-circle"></div>
                <div class="brand-text">
                    <div class="brand-name">Declar</div>
                    <div class="brand-tagline">Compliance Hub</div>
                </div>
            </div>

            <div class="breadcrumb">
                <a href="@Url.Action("Index", "Home")">Dashboard</a>
                <span>›</span>
                <a href="@Url.Action("Employees", "Home")">Employees</a>
                <span>›</span>
                <span>@Model.Employee.Full_Name</span>
            </div>
        </div>
    </header>

    <main>
        @Html.AntiForgeryToken()
        <!-- Profile Hero -->
        <div class="profile-hero">
            <div class="hero-content">
                <div class="profile-header">
                    <div class="profile-identity">
                        <div class="large-avatar">
                            @(string.IsNullOrEmpty(Model.Employee.Full_Name) ? "EE" : Model.Employee.Full_Name.Substring(0, Math.Min(2, Model.Employee.Full_Name.Length)).ToUpper())
                        </div>
                        <div class="profile-info">
                            <h1>@Model.Employee.Full_Name</h1>
                            <div class="profile-meta">
                                <div class="meta-item">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    @Model.Employee.Position
                                </div>
                                <div class="meta-item">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                    @Model.Employee.Department
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-card">
                        <div class="compliance-label">Overall Compliance Rate</div>
                        <div class="compliance-value">@Model.ComplianceRate.ToString("F1")%</div>
                        <div class="compliance-progress">
                            <div class="compliance-progress-bar" style="width: @Model.ComplianceRate%;"></div>
                        </div>
                        <div class="compliance-status">
                            @(Model.ComplianceRate >= 95 ? "🎉 Goal Achieved!" : $"{(95 - Model.ComplianceRate):F1}% to goal")
                        </div>
                    </div>
                </div>

                <div class="hero-actions">
                    <a href="@Url.Action("Employees", "Home")" class="back-button">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <button class="btn btn-primary" onclick="location.href='@Url.Action("BulkRequest", "Home", new { employeeIds = new int[] { Model.Employee.EmployeeId } })'">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" />
                        </svg>
                        Assign New DOI
                    </button>
                    <button class="btn btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#statusModal">
                        @(Model.Employee.IsActive ? "Deactivate" : "Activate")
                    </button>


                    <button class="btn btn-ghost">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-icon">🆔</div>
                    <div class="info-label">Employee ID</div>
                </div>
                <div class="info-value">@Model.Employee.EmployeeNumber</div>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-icon">📧</div>
                    <div class="info-label">Email Address</div>
                </div>
                <div class="info-value">@Model.Employee.Email_Address</div>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-icon">🏢</div>
                    <div class="info-label">Department</div>
                </div>
                <div class="info-value">@Model.Employee.Department</div>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <div class="info-icon">📊</div>
                    <div class="info-label">Total DOIs</div>
                </div>
                <div class="info-value">@Model.Tasks.Count</div>
            </div>
        </div>

        <!-- DOI Compliance History -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">DOI Compliance History</h2>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-ghost" style="color: var(--color-primary); border-color: var(--color-primary);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        Filter
                    </button>
                    <button class="btn btn-primary">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Export History
                    </button>
                </div>
            </div>

            @if (!Model.Tasks.Any())
            {
                <div class="empty-state">
                    <svg width="100" height="100" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>No DOI tasks assigned yet</h3>
                    <p>This employee has not been assigned any Declaration of Interest forms.</p>
                </div>
            }
            else
            {
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Form Template</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Compliance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in Model.Tasks.OrderByDescending(t => t.DueDate))
                            {
                                var statusClass = task.Status.ToLower() switch
                                {
                                    "completed" or "reviewed" => "success",
                                    "overdue" => "danger",
                                    "pending" or "outstanding" => "warning",
                                    _ => "warning"
                                };

                                var daysRemaining = (task.DueDate - DateTime.Now).Days;
                                var complianceText = task.Status.ToLower() == "completed" || task.Status.ToLower() == "reviewed"
                                                        ? "Compliant"
                                                        : daysRemaining < 0
                                                                ? $"{Math.Abs(daysRemaining)} days overdue"
                                : $"{daysRemaining} days remaining";

                                <tr>
                                    <td><strong>@task.Template</strong></td>
                                    <td>@task.DueDate.ToString("MMM dd, yyyy")</td>
                                    <td><span class="status-badge @statusClass">@task.Status</span></td>
                                    <td style="color: @(statusClass == "success" ? "var(--color-success)" : statusClass == "danger" ? "var(--color-danger)" : "var(--color-warning)");">
                                        @complianceText
                                    </td>
                                    <td>
                                        <a href="@Url.Action("ViewSubmission", "Home", new { taskId = task.TaskId })" class="btn-action">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            View
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Direct Reports Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Direct Reports (@Model.Subordinates.Count)</h2>
                @if (Model.Subordinates.Any())
                {
                    <button class="btn btn-primary" onclick="location.href='@Url.Action("BulkRequest", "Home", new { employeeIds = Model.Subordinates.Select(s => s.EmployeeId).ToArray() })'">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Assign DOI to Team
                    </button>
                }
            </div>

            @if (!Model.Subordinates.Any())
            {
                <div class="empty-state">
                    <svg width="100" height="100" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <h3>No direct reports</h3>
                    <p>This employee currently has no subordinates assigned to them.</p>
                </div>
            }
            else
            {
                <div class="team-grid">
                    @foreach (var sub in Model.Subordinates)
                    {
                        // Placeholder compliance rate - replace with real calculation if available
                        double subCompliance = 88.5;

                        <div class="team-card">
                            <div class="team-header">
                                <div class="team-avatar">
                                    @(sub.Full_Name?.Substring(0, Math.Min(2, sub.Full_Name?.Length ?? 0)).ToUpper() ?? "EE")
                                </div>
                                <div class="team-info">
                                    <h3>@sub.Full_Name</h3>
                                    <p>@sub.Position</p>
                                </div>
                            </div>
                            <div class="team-stats">
                                <div class="stat-row">
                                    <span class="stat-label-small">Compliance Rate</span>
                                    <span class="stat-value-small">@subCompliance.ToString("F1")%</span>
                                </div>
                                <div class="mini-progress">
                                    <div class="mini-progress-bar" style="width: @subCompliance%;"></div>
                                </div>
                            </div>
                            <a href="@Url.Action("EmployeeDetails", "Home", new { id = sub.EmployeeId })" class="btn-action" style="width: 100%; justify-content: center; text-align: center;">
                                View Profile
                            </a>
                        </div>
                    }
                </div>
            }
        </div>
    </main>

    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-custom">
                <div class="modal-header @(Model.Employee.IsActive ? "" : "modal-danger")">
                    <h5 class="modal-title" id="statusModalLabel">
                        @(Model.Employee.IsActive ? "Employee Active" : "Employee Inactive")
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Employee <strong>@Model.Employee.Full_Name</strong> is currently
                        <span class="status-badge @(Model.Employee.IsActive ? "success" : "danger")">
                            @(Model.Employee.IsActive ? "Active" : "Inactive")
                        </span>.
                    </p>
                    <p>You can update their status or perform other actions below.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="toggleStatus('@Model.Employee.EmployeeId')">
                        @(Model.Employee.IsActive ? "Deactivate" : "Activate")
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <script>
                function toggleStatus(employeeId) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('@Url.Action("ToggleEmployeeActive", "Home")', {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "RequestVerificationToken": token
                },
                body: new URLSearchParams({
                    employeeId: employeeId
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Hide modal after successful toggle
                    var modalEl = document.getElementById('statusModal');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Reload page or update status badge dynamically
                    location.reload();
                }
            })
            .catch(err => console.error(err));
        }


    </script>


</body>
</html>